(function (b) {
    config.init();
    var a = false;
    b("#firstStep").on("tap", function () {
        var e = this;
        if (validate.check("#firstForm")) {
            var f = {
                doing: function () {
                    b("#lastForm").css({display: "block"});
                    b(e).parent().parent().css({display: "none"});
                    b("#trueName").attr("readonly", "readonly");
                    b("#idNo").attr("readonly", "readonly");
                    b("#loginName").attr("readonly", "readonly")
                }
            };
            var d = {
                hospitalId: b("#hospital").val(),
                idNo: b("#idNo").val().trim(),
                trueName: b("#trueName").val().trim(),
                phone: b("#loginName").val().trim()
            };
            var c = {
                doing: function (h) {
                    var g = 1;
                    a = true;
                    if (h) {
                        if (d.phone != h[0].phone) {
                            g = 2500;
                            hzAPI.dialog(false, g, "与医院登记的手机号码不符,请到医院挂号处修改手机号码");
                            d.phone = h[0].phone
                        } else {
                            setTimeout(function () {
                                hzAPI.check("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=checkPhone", d, ["请点击蓝色的“获取验证码”", "该手机号已被注册"], f)
                            }, g)
                        }
                    } else {
                        setTimeout(function () {
                            hzAPI.check("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=checkPhone", d, ["请点击蓝色的“获取验证码”", "该手机号已被注册"], f)
                        }, g)
                    }
                }, err: {
                    doing: function (g) {
                        if (g == "输入的身份证号和姓名与医院登记不符") {
                            hzAPI.dialog(false, 2500, g)
                        } else {
                            hzAPI.check("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=checkPhone", d, ["请点击蓝色的“获取验证码”", "该手机号已被注册"], f)
                        }
                    }
                }
            };
            hzAPI.register("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=confirmPatient", d, [null, null], c)
        }
    });
    b("#sure").on("tap", function () {
        if (validate.check("#lastForm")) {
            var d = {
                hospitalId: b("#hospital").val(),
                idNo: b("#idNo").val(),
                trueName: b("#trueName").val(),
                loginName: b("#loginName").val(),
                code: b("#smsCode").val(),
                password: b("#password").val(),
                birthDay: b("#idNo").val().substr(6, 8).replace(/(.{4})(.{2})/, "$1-$2-"),
                sex: (b("#idNo").val().substr(b("#idNo").val().length - 2, 1) % 2 == 0) ? "女" : "男"
            };
            var c = {
                doing: function () {
                    setTimeout(function () {
                        hzAPI.sendData("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=login", d, true)
                    }, 100)
                }
            };
            if (a) {
                hzAPI.register("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=register", d, [null, "注册成功"], c)
            } else {
                hzAPI.register("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=registerNew", d, [null, "注册成功"], c)
            }
        }
    });
    b("#smsBt").on("click", function () {
        var c = {
            hospitalId: b("#hospital").val(),
            idNo: b("#idNo").val(),
            trueName: b("#trueName").val(),
            phone: b("#loginName").val()
        };
        timerBt.updateTimer("#smsBt");
        setTimeout(function () {
            hzAPI.register("http://ywtwx.dept.nfyy.com/ywtapi/?c=Other&a=registerVerifyCode", c)
        }, 100)
    })
})(Zepto);