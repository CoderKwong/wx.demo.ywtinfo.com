(function (g) {
    config.init();
    var d = {};
    var a = {
        idCk: Fx.getUrlParam("id"),
        hospitalIdCk: Fx.getUrlParam("hospitalId")
    };
    g("#back").on("tap",
    function () {
        g("#popup_layer").removeClass("show")
    });
    g("#cancelFlag").on("tap",
    function () {
        if (!g(this).hasClass("disable")) {
            g("#popup_layer").removeClass("show");
            var i = {
                doing: function () {
                    if (h.isCard) {
                        setTimeout(function () {
                            f.doing()
                        },
                        2000)
                    } else {
                        window.location = "doctorCalendar.html"
                    }
                }
            };
            if (d.payFlag == "0") {
                hzAPI.sendData("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=returnPay", g.extend(d, { 
                    patientId: JSON.parse(g("ul.card a").attr("data")).patientId
                }), false, ["退费失败", "退费成功"], null, null, i)
            } else {
                hzAPI.sendData("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=cancelOrder", d, false, ["取消挂号失败", "取消挂号成功"], null, null, i)
            }
        }
    });
    g("#payFlag").on("tap",
    function () {
        if (!g(this).hasClass("disable")) {
            g("#popup_layer").removeClass("show");
            if (h.isCard) {
                var i = {
                    doing: function () {
                        setTimeout(function () {
                            f.doing()
                        },
                        2000)
                    }
                };
                hzAPI.sendData("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=payOrder", g.extend(d, {
                    payMode: 1,
                    payCardNum: JSON.parse(g("ul.card a").attr("data")).cardId,
                    patientId: JSON.parse(g("ul.card a").attr("data")).patientId
                }), false, ["支付失败,请就诊当天到医院人工窗口取号", "支付成功"], null, null, i)
            }
        }
    });
    var b = {
        doing: function () {
            hzAPI.scroll("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=historyListForPay", h, "#list ul.historyList", 1, false);
            g("ul.historyList li a").on("tap",
            function () {
                d = JSON.parse(g(this).attr("data"));
                if (d.returnFlag == "0") {
                    if (!g("#cancelFlag").hasClass("disable")) {
                        g("#cancelFlag").addClass("disable");
                        g("#cancelFlag i").addClass("disable");
                        g("#payFlag").addClass("disable");
                        g("#payFlag i").addClass("disable")
                    }
                } else {
                    if (d.payFlag == "0") {
                        if (!g("#payFlag").hasClass("disable")) {
                            g("#payFlag").addClass("disable");
                            g("#payFlag i").addClass("disable")
                        }
                    } else {
                        if (g("#payFlag").hasClass("disable")) {
                            g("#payFlag").removeClass("disable");
                            g("#payFlag i").removeClass("disable")
                        }
                        if (g("#cancelFlag").hasClass("disable")) {
                            g("#cancelFlag").removeClass("disable");
                            g("#cancelFlag i").removeClass("disable")
                        }
                    }
                }
                if (!g("#popup_layer").hasClass("show")) {
                    g("#popup_layer").addClass("show")
                }
                if (!h.isCard) {
                    if (!g("#payFlag").hasClass("disable")) {
                        g("#payFlag").addClass("disable");
                        g("#payFlag i").addClass("disable")
                    }
                }
            })
        }
    };
    var h = {
        isCard: true, 
        rowed: 0,
        pageSize: 5
    };
    var c = {
        doing: function () {
            var j = JSON.parse(g("ul.card a").attr("data"));
            var i = {
                customerFamilyId: g("#familyList").val(),
				hospitalId: g("#hospitalId").val()
            };
            g.extend(h, i);
            hzAPI.getData("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=historyListForPay", h, "#list ul.historyList", 3, true, null, true, "无支付记录", b)
        }
    };
    var f = {
        parameters: {},
        doing: function () {
            g("#hospital ul").css({
                display: "block"
            });
            var i = {
                customerFamilyId: g("#familyList").val(),
                hospitalId: g("#hospitalId").val(),
                hospitalName: g("#hospitalId").text().trim()
            };
            g.extend(f.parameters, i);
            hzAPI.getData("http://ywtwx.dept.nfyy.com/ywtapi/?c=ReqHis&a=cardMoney", f.parameters, "#list ul.card", 2, true, null, true, "未办理诊疗卡", c, f.err)
        },
        err: {
            doing: function () {
                g("#idNoBlock ul").show()
            }
        }
    };
    var e = {
        doing: function () {
            var i = {
                customerFamilyId: g("#familyList").val(),
                hospitalIdCk: a.hospitalIdCk
            };
            hzAPI.getData("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=customerCardHospitalList", i, "#hospitalId", 1, true, null, true, "未绑定或未办理诊疗卡", f, e.err)
        },
        err: {
            doing: function () {
                g("#hospital ul").css({
                    display: "none"
                });
                h.isCard = false;
                c.doing()
            }
        },
        init: function () {
            hzAPI.getData("http://ywtwx.dept.nfyy.com/ywtapi/?c=Index&a=customerFamilyList", a, "#familyList", 0, true, null, true, null, e)
        }
    };
    e.init();
    icoNav.ton(".popup_layer li");
    g("#familyList").on("change",
    function () {
        a.idCk = g(this).val();
        e.doing()
    })
})(Zepto);